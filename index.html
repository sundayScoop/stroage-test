<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Parent â€“ Storage Access Grant</title>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    button { padding: .5em 1em; margin-bottom: 1em; }
    iframe { border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Parent Frame</h1>

  <!-- 1) Button to kick off our popup-based grant -->
  <button id="grantBtn">Grant Storage Access via Popup</button>

  <!-- 2) Embed the child as a sandboxed iframe -->
  <iframe
    id="childFrame"
    src="http://localhost:8080/child.html"
    width="600" height="400"
    sandbox="allow-scripts allow-same-origin allow-storage-access-by-user-activation">
  </iframe>

  <script>
    const CHILD_ORIGIN = 'http://localhost:8080';
    const grantBtn   = document.getElementById('grantBtn');
    const iframe     = document.getElementById('childFrame');

    // When the user clicks in *this* parent frame, open the popup.
    grantBtn.addEventListener('click', () => {
      window.open(
        `${CHILD_ORIGIN}/child.html?grant=1`,
        'saa-grant-popup',
        'width=400,height=300'
      );
    });

    // Listen for messages from either the popup or the iframe.
    window.addEventListener('message', e => {
      if (e.origin !== CHILD_ORIGIN) return;

      // 3a) The popup (child.html?grant=1) will send this once it's done calling requestStorageAccess()
      if (e.data === 'storage-granted') {
        // Relay into the sandboxed iframe so it can re-run its storage logic
        iframe.contentWindow.postMessage('storage-granted', CHILD_ORIGIN);
      }
    });
  </script>
</body>
</html>
